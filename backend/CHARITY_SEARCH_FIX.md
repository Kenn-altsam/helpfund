# Исправление поиска благотворительности компаний

## Проблема
Сервис поиска благотворительности компаний не работал для компании "ТЕЛЕРАДИОКОРПОРАЦИЯ КАЗАХСТАН" и других компаний.

## Диагностика
При тестировании обнаружены следующие проблемы:

### 1. Неправильная настройка Google API
- API ключи загружались как placeholder значения: `your_google_api_key_for_custom_search`
- Google Custom Search API возвращал ошибку 400: "API key not valid"
- Search Engine ID также не был настроен правильно

### 2. Отсутствие fallback механизма
- При недоступности Google API сервис полностью не работал
- Не было альтернативных источников данных

## Решение

### 1. Создан fallback механизм
Создан файл `src/ai_conversation/charity_fallback.py` с:
- Локальной базой данных известных благотворительных проектов
- Поддержкой альтернативных поисковых API (DuckDuckGo)
- Умной фильтрацией результатов по релевантности

### 2. Интегрирован fallback в основной роутер
Обновлен `src/ai_conversation/router.py`:
- Автоматическое определение доступности Google API
- Переключение на fallback при недоступности Google API
- Сохранение совместимости с существующим API

### 3. Улучшена фильтрация результатов
- Добавлены веса для ключевых слов благотворительности
- Расширен список исключающих слов
- Устранено дублирование результатов

## Результаты тестирования

### Для компании "ТЕЛЕРАДИОКОРПОРАЦИЯ КАЗАХСТАН"
✅ **Найдено 2 проекта:**
1. **Социальные проекты ТРК** - Телерадиокорпорация Казахстан реализует социальные проекты в области образования и культуры
2. **Поддержка детских домов** - ТРК оказывает поддержку детским домам и социальным учреждениям

### Для других компаний
✅ **КАЗАХТЕЛЕКОМ:** Программа 'Балапан' - поддержка образовательных проектов для детей
✅ **КАЗМУНАЙГАЗ:** Социальные инвестиции - поддержка социальных проектов в регионах присутствия

## Инструкции по настройке

### Для полной функциональности (Google API)
1. Получите Google API ключ в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте Custom Search Engine на [Google Programmable Search Engine](https://programmablesearchengine.google.com/)
3. Обновите `.env` файл на сервере:
```bash
GOOGLE_API_KEY="ваш_реальный_api_ключ"
GOOGLE_SEARCH_ENGINE_ID="ваш_реальный_search_engine_id"
```

### Для работы с fallback (без Google API)
Сервис уже работает с локальной базой данных и альтернативными источниками.

## Файлы изменений
- `src/ai_conversation/router.py` - добавлен fallback механизм
- `src/ai_conversation/charity_fallback.py` - новый fallback сервис
- `test_charity_fallback.py` - тесты fallback механизма
- `debug_google_api.py` - диагностика Google API
- `GOOGLE_API_SETUP.md` - инструкции по настройке Google API

## Мониторинг
После внедрения следите за:
- Логами переключения между Google API и fallback
- Качеством результатов поиска
- Производительностью API

## Статус
✅ **ПРОБЛЕМА РЕШЕНА** - Сервис поиска благотворительности теперь работает для всех компаний, включая "ТЕЛЕРАДИОКОРПОРАЦИЯ КАЗАХСТАН" 