import json
from functools import lru_cache
from typing import Optional

# Import the specific client and errors for robustness
from openai import OpenAI, APIConnectionError, AuthenticationError, RateLimitError

from ..core.config import get_settings

# Use a global variable for a singleton client, initialized as None
_client: Optional[OpenAI] = None

# A constant for the prompt makes it easier to manage
LOCATION_EXTRACTION_PROMPT = """
You are an expert in Kazakh geography. Your task is to extract ONE canonical city or region name from the user's text.

AVAILABLE REGIONS IN DATABASE (2015-2017 data):
- –ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å  
- –ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –Æ–∂–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å
- –£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å

MAJOR CITIES:
- –ê–ª–º–∞—Ç—ã (Almaty, –ê–ª–º–∞—Ç–µ, –ê–ª–º–∞—Ç–∞)
- –ê—Å—Ç–∞–Ω–∞ (Astana, Nur-Sultan, –ù—É—Ä-–°—É–ª—Ç–∞–Ω)
- –®—ã–º–∫–µ–Ω—Ç (Shymkent, –ß–∏–º–∫–µ–Ω—Ç)
- –ê–∫—Ç–æ–±–µ (Aktobe, –ê–∫—Ç—é–±–∏–Ω—Å–∫)
- –¢–∞—Ä–∞–∑ (Taraz, –î–∂–∞–º–±—É–ª)
- –ü–∞–≤–ª–æ–¥–∞—Ä (Pavlodar)
- –£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫ (Ust-Kamenogorsk, –û—Å–∫–µ–º–µ–Ω)
- –°–µ–º–µ–π (Semey, –°–µ–º–∏–ø–∞–ª–∞—Ç–∏–Ω—Å–∫)
- –ê—Ç—ã—Ä–∞—É (Atyrau, –ì—É—Ä—å–µ–≤)
- –ö–æ—Å—Ç–∞–Ω–∞–π (Kostanay)
- –ü–µ—Ç—Ä–æ–ø–∞–≤–ª (Petropavl, –ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫)
- –ö–∞—Ä–∞–≥–∞–Ω–¥–∞ (Karaganda)
- –ê–∫—Ç–∞—É (Aktau, –®–µ–≤—á–µ–Ω–∫–æ)
- –ö—ã–∑—ã–ª–æ—Ä–¥–∞ (Kyzylorda)

RULES:
- If the city is in Latin (e.g., Almaty, Astana), convert it to Cyrillic (–ê–ª–º–∞—Ç—ã, –ê—Å—Ç–∞–Ω–∞).
- If multiple cities are mentioned, return only the most prominent one.
- If no recognizable city or region is found, return the word "null".
- For regions: convert any form to canonical form (e.g., "–£–ª—ã—Ç–∞—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏" -> "–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å")
- IMPORTANT: If a region is not in the available list above, return "null" and do not guess.
- Handle common misspellings: "–ê–ª–º–∞—Ç–µ" -> "–ê–ª–º–∞—Ç—ã", "–ê–ª–º–∞—Ç–∞" -> "–ê–ª–º–∞—Ç—ã"
- Respond with ONLY the city name or region name or "null". Do not add any other text.

EXAMPLES:
Example 1: "Find me IT companies in Almaty" -> "–ê–ª–º–∞—Ç—ã"
Example 2: "I'm looking for a sponsor" -> "null"
Example 3: "–ì–æ—Ä–Ω–æ–¥–æ–±—ã–≤–∞—é—â–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –®—ã–º–∫–µ–Ω—Ç–∞" -> "–®—ã–º–∫–µ–Ω—Ç"
Example 4: "–£–ª—ã—Ç–∞—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏" -> "null" (not in database)
Example 5: "–ê–ª–º–∞—Ç–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏" -> "–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
Example 6: "–≤ –ê—Ç—ã—Ä–∞—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏" -> "–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
Example 7: "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å" -> "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
Example 8: "–ù–∞–π–¥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –ê–ª–º–∞—Ç–µ" -> "–ê–ª–º–∞—Ç—ã"
Example 9: "–∫–æ–º–ø–∞–Ω–∏–∏ –ê–ª–º–∞—Ç—ã" -> "–ê–ª–º–∞—Ç—ã"
Example 10: "–í–ö–û" -> "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
Example 11: "–°–ö–û" -> "–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
Example 12: "–Æ–ö–û" -> "–Æ–∂–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
Example 13: "–ó–ö–û" -> "–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
"""

# Simple fallback logic for common cities when AI is unavailable
SIMPLE_CITY_PATTERNS = {
    # –ê–ª–º–∞—Ç—ã variations
    "–∞–ª–º–∞—Ç–µ": "–ê–ª–º–∞—Ç—ã",
    "–∞–ª–º–∞—Ç–∞": "–ê–ª–º–∞—Ç—ã", 
    "–∞–ª–º–∞—Ç—ã": "–ê–ª–º–∞—Ç—ã",
    "almaty": "–ê–ª–º–∞—Ç—ã",
    "–≤ –∞–ª–º–∞—Ç–µ": "–ê–ª–º–∞—Ç—ã",
    "–≤ –∞–ª–º–∞—Ç—ã": "–ê–ª–º–∞—Ç—ã",
    "–∞–ª–º–∞—Ç–µ": "–ê–ª–º–∞—Ç—ã",
    # –ê—Å—Ç–∞–Ω–∞ variations
    "–∞—Å—Ç–∞–Ω–∞": "–ê—Å—Ç–∞–Ω–∞",
    "astana": "–ê—Å—Ç–∞–Ω–∞",
    "–Ω—É—Ä-—Å—É–ª—Ç–∞–Ω": "–ê—Å—Ç–∞–Ω–∞",
    "nur-sultan": "–ê—Å—Ç–∞–Ω–∞",
    "–∞—Å—Ç–∞–Ω–µ": "–ê—Å—Ç–∞–Ω–∞",
    "–≤ –∞—Å—Ç–∞–Ω–µ": "–ê—Å—Ç–∞–Ω–∞",
    # –®—ã–º–∫–µ–Ω—Ç variations
    "—à—ã–º–∫–µ–Ω—Ç": "–®—ã–º–∫–µ–Ω—Ç",
    "shymkent": "–®—ã–º–∫–µ–Ω—Ç",
    "—á–∏–º–∫–µ–Ω—Ç": "–®—ã–º–∫–µ–Ω—Ç",
    # –ê–∫—Ç–æ–±–µ variations
    "–∞–∫—Ç–æ–±–µ": "–ê–∫—Ç–æ–±–µ",
    "aktobe": "–ê–∫—Ç–æ–±–µ",
    "–∞–∫—Ç—é–±–∏–Ω—Å–∫": "–ê–∫—Ç–æ–±–µ",
    # –¢–∞—Ä–∞–∑ variations
    "—Ç–∞—Ä–∞–∑": "–¢–∞—Ä–∞–∑",
    "taraz": "–¢–∞—Ä–∞–∑",
    "–¥–∂–∞–º–±—É–ª": "–¢–∞—Ä–∞–∑",
    # –ü–∞–≤–ª–æ–¥–∞—Ä variations
    "–ø–∞–≤–ª–æ–¥–∞—Ä": "–ü–∞–≤–ª–æ–¥–∞—Ä",
    "pavlodar": "–ü–∞–≤–ª–æ–¥–∞—Ä",
    # –£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫ variations
    "—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫": "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫",
    "ust-kamenogorsk": "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫",
    "–æ—Å–∫–µ–º–µ–Ω": "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫",
    # –°–µ–º–µ–π variations
    "—Å–µ–º–µ–π": "–°–µ–º–µ–π",
    "semey": "–°–µ–º–µ–π",
    "—Å–µ–º–∏–ø–∞–ª–∞—Ç–∏–Ω—Å–∫": "–°–µ–º–µ–π",
    # –ê—Ç—ã—Ä–∞—É variations
    "–∞—Ç—ã—Ä–∞—É": "–ê—Ç—ã—Ä–∞—É",
    "atyrau": "–ê—Ç—ã—Ä–∞—É",
    "–≥—É—Ä—å–µ–≤": "–ê—Ç—ã—Ä–∞—É",
    # –ö–æ—Å—Ç–∞–Ω–∞–π variations
    "–∫–æ—Å—Ç–∞–Ω–∞–π": "–ö–æ—Å—Ç–∞–Ω–∞–π",
    "kostanay": "–ö–æ—Å—Ç–∞–Ω–∞–π",
    # –ü–µ—Ç—Ä–æ–ø–∞–≤–ª variations
    "–ø–µ—Ç—Ä–æ–ø–∞–≤–ª": "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª",
    "petropavl": "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª",
    "–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫": "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª",
    # –ö–∞—Ä–∞–≥–∞–Ω–¥–∞ variations
    "–∫–∞—Ä–∞–≥–∞–Ω–¥–∞": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞",
    "karaganda": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞",
    # –ê–∫—Ç–∞—É variations
    "–∞–∫—Ç–∞—É": "–ê–∫—Ç–∞—É",
    "aktau": "–ê–∫—Ç–∞—É",
    "—à–µ–≤—á–µ–Ω–∫–æ": "–ê–∫—Ç–∞—É",
    # –ö—ã–∑—ã–ª–æ—Ä–¥–∞ variations
    "–∫—ã–∑—ã–ª–æ—Ä–¥–∞": "–ö—ã–∑—ã–ª–æ—Ä–¥–∞",
    "kyzylorda": "–ö—ã–∑—ã–ª–æ—Ä–¥–∞",
}

# Simple region patterns
SIMPLE_REGION_PATTERNS = {
    "–∞–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞–ª–º–∞—Ç–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞—Ç—ã—Ä–∞—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞–∫—Ç—é–±–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫–æ—Å—Ç–∞–Ω–∞–π—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–º–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–º–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–ø–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–ø–∞–≤–ª–æ–¥–∞—Ä—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–∞–º–±—ã–ª—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–≤–æ—Å—Ç–æ—á–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–≤–æ—Å—Ç–æ—á–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∑–∞–ø–∞–¥–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∑–∞–ø–∞–¥–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞–∫–º–æ–ª–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—é–∂–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–Æ–∂–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—é–∂–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–Æ–∂–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—É–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—É–ª—ã—Ç–∞—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    # Additional canonical forms
    "–∞–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞–±–∞–π—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–µ—Ç–∏—Å—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–µ—Ç—ã—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–µ—Ç—ã—Å—É—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    # Region names without "–æ–±–ª–∞—Å—Ç—å"
    "–∞–±–∞–π": "–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–µ—Ç—ã—Å—É": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–µ—Ç–∏—Å—É": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç—å –∞–±–∞–π": "–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç—å –∂–µ—Ç—ã—Å—É": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç—å –∂–µ—Ç–∏—Å—É": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    # Other regions without "–æ–±–ª–∞—Å—Ç—å"
    "–∞–∫–º–æ–ª–∞": "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞–ª–º–∞—Ç—ã": "–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∞—Ç—ã—Ä–∞—É": "–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–≤–æ—Å—Ç–æ—á–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∂–∞–º–±—ã–ª": "–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∑–∞–ø–∞–¥–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫–∞—Ä–∞–≥–∞–Ω–¥–∞": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫–æ—Å—Ç–∞–Ω–∞–π": "–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–∫—ã–∑—ã–ª–æ—Ä–¥–∞": "–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–º–∞–Ω–≥–∏—Å—Ç–∞—É": "–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–ø–∞–≤–ª–æ–¥–∞—Ä": "–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—Å–µ–≤–µ—Ä–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—Ç—É—Ä–∫–µ—Å—Ç–∞–Ω": "–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—É–ª—ã—Ç–∞—É": "–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—é–∂–Ω—ã–π –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–Æ–∂–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—Å–µ–≤–µ—Ä–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—Å–µ–≤–µ—Ä–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—Ç—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": "–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "—Ç—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏": "–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    # –û–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –¥–ª—è –æ–±–ª–∞—Å—Ç–µ–π
    "–æ–±–ª–∞—Å—Ç–∏ –∞–ª–º–∞—Ç—ã": "–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∞—Ç—ã—Ä–∞—É": "–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∞–∫—Ç–æ–±–µ": "–ê–∫—Ç—é–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä–∞–≥–∞–Ω–¥–∞": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∫–æ—Å—Ç–∞–Ω–∞–π": "–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∫—ã–∑—ã–ª–æ—Ä–¥–∞": "–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –º–∞–Ω–≥–∏—Å—Ç–∞—É": "–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –ø–∞–≤–ª–æ–¥–∞—Ä": "–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∂–∞–º–±—ã–ª": "–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –≤–æ—Å—Ç–æ—á–Ω—ã–π –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∑–∞–ø–∞–¥–Ω—ã–π –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∞–∫–º–æ–ª–∞": "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ —é–∂–Ω—ã–π –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–Æ–∂–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ —É–ª—ã—Ç–∞—É": "–£–ª—ã—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    # Additional region mappings
    "–æ–±–ª–∞—Å—Ç–∏ –∞–±–∞–π": "–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∂–µ—Ç—ã—Å—É": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∂–µ—Ç–∏—Å—É": "–ñ–µ—Ç–∏—Å—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∞–∫–º–æ–ª–∞": "–ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∞–ª–º–∞—Ç—ã": "–ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∞—Ç—ã—Ä–∞—É": "–ê—Ç—ã—Ä–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –≤–æ—Å—Ç–æ—á–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∂–∞–º–±—ã–ª": "–ñ–∞–º–±—ã–ª—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∑–∞–ø–∞–¥–Ω–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–ó–∞–ø–∞–¥–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä–∞–≥–∞–Ω–¥–∞": "–ö–∞—Ä–∞–≥–∞–Ω–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∫–æ—Å—Ç–∞–Ω–∞–π": "–ö–æ—Å—Ç–∞–Ω–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –∫—ã–∑—ã–ª–æ—Ä–¥–∞": "–ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –º–∞–Ω–≥–∏—Å—Ç–∞—É": "–ú–∞–Ω–≥–∏—Å—Ç–∞—É—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ –ø–∞–≤–ª–æ–¥–∞—Ä": "–ü–∞–≤–ª–æ–¥–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ —Å–µ–≤–µ—Ä–æ-–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": "–°–µ–≤–µ—Ä–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–æ–±–ª–∞—Å—Ç–∏ —Ç—É—Ä–∫–µ—Å—Ç–∞–Ω": "–¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
}

def extract_location_simple(text: str) -> Optional[str]:
    """
    Simple fallback function to extract location without AI
    """
    if not text:
        return None
        
    text_lower = text.lower()
    
    # Check for regions first
    for pattern, canonical in SIMPLE_REGION_PATTERNS.items():
        if pattern in text_lower:
            return canonical
    
    # Check for cities
    for pattern, canonical in SIMPLE_CITY_PATTERNS.items():
        if pattern in text_lower:
            return canonical
    
    return None

def get_client() -> OpenAI:
    """
    Safely initializes and returns a singleton OpenAI client.
    This "lazy initialization" prevents the app from crashing at startup if keys are missing.
    """
    global _client
    if _client is None:
        print("üîß Initializing OpenAI client for location service...")
        settings = get_settings()
        
        # Explicitly check for required settings
        if not settings.OPENAI_API_KEY:
            raise ValueError("OPENAI_API_KEY is not configured for the location service.")
        
        _client = OpenAI(
            api_key=settings.OPENAI_API_KEY,
            timeout=15.0, # Add a timeout for network resilience
        )
    return _client

@lru_cache(maxsize=256) # Increased cache size
def get_canonical_location_from_text(text: str) -> Optional[str]:
    """
    Uses OpenAI to extract the canonical city name from a user's query.
    Results are cached, and specific API errors are handled gracefully.
    Falls back to simple pattern matching if AI is unavailable.
    """
    if not text.strip():
        return None

    # First try simple pattern matching as fallback
    simple_result = extract_location_simple(text)
    if simple_result:
        print(f"‚úÖ Found location using simple pattern matching: '{simple_result}'")
        return simple_result

    try:
        # This will log only when the API is actually called (not a cache hit)
        print(f"üß† Calling OpenAI API for location extraction: '{text[:50]}...'")
        
        settings = get_settings()
        client = get_client()
        response = client.chat.completions.create(
            model=settings.OPENAI_MODEL_NAME,
            messages=[
                {"role": "system", "content": LOCATION_EXTRACTION_PROMPT},
                {"role": "user", "content": text}
            ],
            temperature=0.0,
            max_tokens=20
        )
        
        location = response.choices[0].message.content.strip()

        if location.lower() == "null" or not location:
            return None
        
        return location

    except (APIConnectionError, RateLimitError) as e:
        print(f"‚ùå OpenAI network/rate limit error in location service: {e}")
        print(f"üîÑ Falling back to simple pattern matching for: '{text[:50]}...'")
        # Try simple pattern matching as fallback
        fallback_result = extract_location_simple(text)
        if fallback_result:
            print(f"‚úÖ Fallback successful: '{fallback_result}'")
            return fallback_result
        return None # Fail gracefully on temporary issues
    except AuthenticationError as e:
        print(f"‚ùå OpenAI authentication error in location service. Check API Key. Error: {e}")
        print(f"üîÑ Falling back to simple pattern matching for: '{text[:50]}...'")
        # Try simple pattern matching as fallback
        fallback_result = extract_location_simple(text)
        if fallback_result:
            print(f"‚úÖ Fallback successful: '{fallback_result}'")
            return fallback_result
        return None
    except Exception as e:
        print(f"‚ùå An unexpected error occurred in location service: {e}")
        print(f"üîÑ Falling back to simple pattern matching for: '{text[:50]}...'")
        # Try simple pattern matching as fallback
        fallback_result = extract_location_simple(text)
        if fallback_result:
            print(f"‚úÖ Fallback successful: '{fallback_result}'")
            return fallback_result
        return None 